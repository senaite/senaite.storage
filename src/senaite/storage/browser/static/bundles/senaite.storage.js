(()=>{var t={311:t=>{"use strict";t.exports=jQuery}},n={};function e(i){var o=n[i];if(void 0!==o)return o.exports;var r=n[i]={exports:{}};return t[i](r,r.exports,e),r.exports}(()=>{"use strict";var t=e(311),n=function(t,n){return function(){return t.apply(n,arguments)}};const i=function(){function e(){return this.debug=n(this.debug,this),this.on_position_slot_click=n(this.on_position_slot_click,this),this.on_position_change=n(this.on_position_change,this),this.bind_eventhandler=n(this.bind_eventhandler,this),console.debug("StoreContainerController::init"),this.bind_eventhandler(),t("#position").change(),this}return e.prototype.bind_eventhandler=function(){return this.debug("StoreContainerController::bind_eventhandler"),t("body").on("click","a.position_slot_selector",this.on_position_slot_click),t("body").on("change","#position",this.on_position_change)},e.prototype.on_position_change=function(n){var e;return this.debug("StoreContainerController::on_position_change"),e=t(n.currentTarget),t("td.empty-slot").removeClass("selected"),t("#"+e.val()).parent("td.empty-slot").addClass("selected")},e.prototype.on_position_slot_click=function(n){var e;if(this.debug("StoreContainerController::on_position_slot_click"),n.preventDefault(),e=t(n.currentTarget),t("#position").val(e.attr("id")),t("#position").change(),t("#sample_uid").val())return t("#button_store").click()},e.prototype.debug=function(t){return console.debug("[senaite.storage] "+t)},e}();var o=e(311),r=function(t,n){return function(){return t.apply(n,arguments)}};const s=function(){function t(){return this.debug=r(this.debug,this),this.get_portal_url=r(this.get_portal_url,this),this.ajax_submit=r(this.ajax_submit,this),this.fetch_available_positions=r(this.fetch_available_positions,this),this.get_selected_positions=r(this.get_selected_positions,this),this.diff=r(this.diff,this),this.fill_container_positions=r(this.fill_container_positions,this),this.get_container_position_selects=r(this.get_container_position_selects,this),this.purge_container_position=r(this.purge_container_position,this),this.add_container_position=r(this.add_container_position,this),this.on_container_position_change=r(this.on_container_position_change,this),this.on_container_change=r(this.on_container_change,this),this.bind_eventhandler=r(this.bind_eventhandler,this),console.debug("StoreSamplesController::init"),this.bind_eventhandler(),this}return t.prototype.bind_eventhandler=function(){return this.debug("StoreSamplesController::bind_eventhandler"),o("body").on("select",".senaite-uidreference-widget-input textarea",this.on_container_change),o("body").on("deselect",".senaite-uidreference-widget-input textarea",this.on_container_change),o("body").on("change","select[container_uid]",this.on_container_position_change)},t.prototype.on_container_change=function(t){var n,e,i,r;this.debug("StoreSamplesController::on_container_change"),e=o(t.currentTarget).closest("div.senaite-uidreference-widget-input"),n=t.detail.value,i=e.attr("sample_uid"),r=o("select#sample_container_position_"+i)[0],this.fill_container_positions(n,r)},t.prototype.on_container_position_change=function(t){var n,e,i,r;if(this.debug("StoreSamplesController::on_container_position_change"),(n=(r=o(t.currentTarget)).attr("container_uid"))&&(i=r.val(),this.purge_container_position(n,i),e=r.attr("original_value"),o(r).attr("original_value",i),e))return this.add_container_position(n,e)},t.prototype.add_container_position=function(t,n){var e;this.debug("StoreSamplesController::add_container_position:container_uid="+t+", position="+n),e=this.get_container_position_selects(t),o.each(e,(function(t,e){var i,r,s;if(i=o(e).find("option"),s=o(i).map((function(){return o(this).val()})),!((s=o.makeArray(s)).indexOf(n)>=0))return s.push(n),s.sort(),r=o(e).val(),o(e).find("option").remove(),o.each(s,(function(t,n){return o(e).append(new Option(n,n))})),o(e).val(r)}))},t.prototype.purge_container_position=function(t,n){var e;this.debug("StoreSamplesController::purge_container_position:container_uid="+t+", position="+n),e=this.get_container_position_selects(t),o.each(e,(function(t,e){if(o(e).val()!==n)return o(e).find("option[value='"+n+"']").remove()}))},t.prototype.get_container_position_selects=function(t){return this.debug("StoreSamplesController::get_container_position_selects:container_uid="+t),o("select[container_uid='"+t+"']")},t.prototype.fill_container_positions=function(t,n){this.debug("StoreSamplesController::fill_container_positions:container_uid="+t),o(n).find("option").remove(),o(n).attr("original_value",""),o(n).attr("container_uid",t),this.fetch_available_positions(t).done((function(e){var i,r,s,a,l;for(l=this.get_selected_positions(t),r=0,s=(i=this.diff(e,o.makeArray(l))).length;r<s;r++)a=i[r],o(n).append(new Option(a,a));o(n).val(i[0]),o(n).trigger("change")})).fail((function(){console.warn("Failed to get available positions")}))},t.prototype.diff=function(t,n){return t.concat(n).filter((function(t,n,e){return e.indexOf(t)===e.lastIndexOf(t)}))},t.prototype.get_selected_positions=function(t){var n;return n=this.get_container_position_selects(t),o(n).map((function(){return o(this).val()}))},t.prototype.fetch_available_positions=function(t){var n,e;return n=o.Deferred(),e="AvailablePositions",this.ajax_submit({url:this.get_portal_url()+"/@@API/read",data:{catalog_name:"uid_catalog",UID:t,include_fields:[e]}}).done((function(t){return n.resolveWith(this,[t.objects[0][e]])})),n.promise()},t.prototype.ajax_submit=function(t){var n;return null==t&&(t={}),null==t.type&&(t.type="POST"),null==t.url&&(t.url=this.get_portal_url()),null==t.context&&(t.context=this),null==t.dataType&&(t.dataType="json"),null==t.data&&(t.data={}),this.debug("ajax_submit::options=",t),o(this).trigger("ajax:submit:start"),n=function(){return o(this).trigger("ajax:submit:end")},o.ajax(t).done(n)},t.prototype.get_portal_url=function(){return o("input[name=portal_url]").val()||window.portal_url},t.prototype.debug=function(t){return console.debug("[senaite.storage] "+t)},t}();document.addEventListener("DOMContentLoaded",(function(){console.debug("*** SENAITE STORAGE JS LOADED ***");var t=document.body.classList;t.contains("template-storage_store_container")&&(window.store_container_controller=new i),t.contains("template-storage_store_samples")&&(window.store_samples_controller=new s)}))})()})();
//# sourceMappingURL=senaite.storage.js.map